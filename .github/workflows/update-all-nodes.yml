name: Update all FRE nodes

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version pushed (ex: v0.0.4)"
        required: true

jobs:
  push-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install curl & jq
        run: sudo apt-get install -y curl jq

      - name: Load nodes list
        id: nodes
        run: |
          NODES=$(cat update/nodes.json | jq -r '.nodes[].url')
          echo "nodes=$NODES" >> $GITHUB_OUTPUT

      - name: Trigger update on each node
        run: |
          for n in ${{ steps.nodes.outputs.nodes }}; do
            echo "Triggering update on $n"
            curl -X POST "$n/admin/update" \
              -H "X-Admin-Token: ${{ secrets.FRE_UPDATE_KEY }}" \
              -H "Content-Type: application/json" || echo "Failed on $n"
          done
